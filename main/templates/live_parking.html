{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Real-time Parking | ParkSpero Melbourne</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@latest/font/lucide.css">
  <style>
    body {
      margin: 0; padding: 0;
      font-family: 'Montserrat', Arial, sans-serif;
      background: linear-gradient(to bottom, #6002ee 0%, #3a1397 60%, #102178 100%);
      color: #421d79;
      min-height: 100vh;
    }
    .navbar { width: 100%; background: linear-gradient(90deg, #be7bf6 0%, #9400ff 80%); display: flex; align-items: center; justify-content: center; gap: 40px; padding: 0 32px; position: relative; min-height: 90px; box-sizing: border-box;}
    .navbar-content { width: 100%; max-width: 1500px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between;}
    .logo-row { display: flex; align-items: center; gap: 18px;}
    .logo-row img { height: 106px; width: 106px; object-fit: contain; filter: drop-shadow(0 2px 10px #1d1a2e80);}
    .site-title { font-size: 1.8rem; font-weight: 900; color: #ffe441; letter-spacing: 1.5px; text-shadow: 0 2px 8px #32246888;}
    .marquee-bar { background: linear-gradient(90deg, #be7bf6cc 0%, #ffe441ee 85%); border-radius: 16px; min-width: 320px; max-width: 320px; height: 44px; margin: 0 18px; box-shadow: 0 2px 12px #963be333, 0 1px 8px #ffe44135; display: flex; align-items: center; overflow: hidden; padding: 0 20px; position: relative;}
    .marquee-text { display: flex; align-items: center; white-space: nowrap; font-weight: 900; color: #421d79; font-size: 1.09em; animation: marquee-move 12s linear infinite; letter-spacing: 0.5px; text-shadow: 0 1px 6px #fff8, 0 1px 3px #be7bf6cc;}
    .marquee-car-img { vertical-align: middle; display: inline-block; height: 22px; margin-right: 12px; margin-bottom: 2px; filter: drop-shadow(0 2px 8px #ffe44190);}
    @keyframes marquee-move { 0% { transform: translateX(50%);} 100% { transform: translateX(-100%);}}
    .nav-links { display: flex; align-items: center; gap: 5px; font-weight: 700; font-size: 0.8rem;}
    .nav-link { color: #ffffff; text-decoration: none; display: flex; align-items: center; gap: 5px; transition: opacity 0.15s; opacity: 0.93; font-size: 1.18em; font-weight: 900; padding: 0.22em 0.86em; border-radius: 10px; position: relative; cursor: pointer;}
    .nav-link:hover, .nav-link:focus-visible { color: #ffd900 !important; text-shadow: 0 0 14px #ffd900cc, 0 0 2px #ffd900cc, 0 1px 6px #fff8; outline: none; opacity: 1; background: none; box-shadow: none;}
    .nav-link.active { color: #ffd900 !important; text-shadow: 0 0 14px #ffd900cc, 0 0 2px #ffd900cc, 0 1px 6px #fff8; background: none; box-shadow: none;}

    .main-wrap { max-width: 1400px; margin: 38px auto 0 auto; padding: 0 12px 40px 12px; display: flex; gap: 34px; align-items: flex-start;}
    .card-section { flex: 1.05; }
    .side-section { flex: 1; }
    .main-card {
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 2px 14px #be7bf655;
        padding: 20px 24px 20px 24px;  /* A little more on both sides*/
        margin-bottom: 18px;
    }

    .main-card h3 { color: #421d79; font-size: 1.2rem; font-weight: 900; margin-bottom: 3px;}
    .main-card p { color: #555; font-size: 1em; font-weight: 500; margin-bottom: 18px;}
    .spot-balls {
  display: flex;
  justify-content: center;   /* Horizontal centering*/
  align-items: flex-start;
  gap: 48px;                 /* The spacing can be adjusted to be a little larger for better symmetry.*/
  margin: 26px 0 18px 0;     /* vertical spacing */
}
    .spot-ball { display: flex; flex-direction: column; align-items: center; cursor: pointer; min-width: 90px;}
    .spot-circle { width: 24px; height: 24px; border-radius: 50%; margin-bottom: 4px;}
    .spot-green { background: #22c55e;}
    .spot-yellow { background: #fde047;}
    .spot-red { background: #ef4444;}
    .spot-title { font-weight: 700; color: #222; font-size: 1em;}
    .spot-desc { font-size: 0.93em; font-weight: 600; margin-top: 3px;}
    .spot-desc.green { color: #039444;}
    .spot-desc.yellow { color: #ba9508;}
    .spot-desc.red { color: #d30820;}
    .action-btns {
  display: flex;
  justify-content: center;   /* Horizontal center alignment */
  gap: 22px;                 /* Distance between buttons*/
  margin: 15px 0 0 0;        /* Zoom in a little. */
}
    .btn-action { background: #111; color: #fff; border: none; border-radius: 13px; font-size: 1em; padding: 10px 30px; font-weight: 700; cursor: pointer; transition: background 0.15s; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px #ccc1;}
    .btn-action:hover { background: #2d0c7b;}
    .refresh-btn { float: right; background: #1f1732; color: #fff; border: none; border-radius: 11px; padding: 7px 20px; font-size: 1.05em; font-weight: 700; margin-bottom: 6px; box-shadow: 0 2px 10px #ccc2;}
    .refresh-btn i { vertical-align: middle; margin-right: 6px;}
    .gmap-card {
    border-radius: 22px;
    overflow: hidden;
    margin-top: 16px;
    margin-bottom: 5px;
    border: 2.5px solid #e6dcff;
    background: none !important;
    padding: 0 !important;
    box-sizing: border-box;
    width: 100%;
    /* Newly added to ensure 100% */
    display: flex;
    flex-direction: column;
}
#parkingMap {
    width: 100% !important;
    height: 570px !important;
    min-height: 240px;
    border-radius: 22px;
    background: none !important;
    margin: 0 !important;
    padding: 0 !important;
    overflow: hidden;
    box-sizing: border-box;
    /* Most important! */
    display: block;
}

    .gmap-card iframe { width: 100%; height: 290px; border: none;}
    .side-card { background: #fff; border-radius: 18px; box-shadow: 0 2px 12px #be7bf650; padding: 19px 23px 12px 23px; margin-bottom: 18px;}
    .side-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;}
    .side-title { font-size: 1.19rem; font-weight: 900; color: #6a3be1;}
    .side-tools { display: flex; gap: 7px;}
    .side-btn { background: #111; color: #fff; border: none; border-radius: 9px; padding: 5px 19px; font-weight: 800; font-size: 1em; display: flex; align-items: center; gap: 6px; cursor: pointer; transition: background 0.13s;}
    .side-btn:hover, .side-btn:active { background: #2d0c7b; color: #ffd900; }
    .parking-list { max-height: 700px; overflow-y: auto; display: flex; flex-direction: column; gap: 13px;}
    .parking-spot-card {
      background: #f9f7ff; border-radius: 14px; box-shadow: 0 2px 12px #be7bf620; padding: 15px 24px 15px 21px; display: flex; flex-direction: column; border: 1.4px solid #e3d2fc;
      position: relative;
      transition: box-shadow 0.22s cubic-bezier(.19,1,.22,1), border-color 0.18s, transform 0.2s cubic-bezier(.19,1,.22,1);
      cursor: pointer;
    }
    .parking-spot-card:hover,
    .parking-spot-card:focus-visible {
      border-color: #a084ff !important;
      box-shadow: 0 4px 28px #be7bf640, 0 2px 12px #7b5fff55;
      transform: translateY(-2px) scale(1.018);
      z-index: 3;
    }
    .parking-spot-card .hover-tip {
      display: none;
      position: absolute;
      top: 9px; right: 20px;
      background: #fff;
      color: #742ae1;
      font-size: 0.93em;
      font-weight: 700;
      padding: 5px 14px;
      border-radius: 11px;
      box-shadow: 0 2px 10px #742ae123;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.19s;
      z-index: 10;
    }
    .parking-spot-card:hover .hover-tip,
    .parking-spot-card:focus-visible .hover-tip {
      display: block;
      opacity: 1;
    }
    .card-row { display: flex; align-items: center; justify-content: space-between;}
    .spot-name { color: #6320c4; font-weight: 900; font-size: 1.13em;}
    .spot-address { font-size: 0.97em; color: #8952e7; margin-bottom: 2px;}
    .badge-available { background: #fff5c3; color: #a98200; border-radius: 13px; padding: 3px 15px; font-size: 0.98em; font-weight: 800; border: 2px solid #ffe441;}
    .badge-available.red { background: #ffdedf; color: #d80013; border-color: #ffbcbc;}
    .badge-available.yellow { background: #fff8e0; color: #c5a100; border-color: #ffe984;}
    .badge-available.green { background: #e2ffed; color: #059640; border-color: #98f3b8;}
    .card-row2 { display: flex; align-items: center; gap: 20px; margin-bottom: 6px;}
    .walk-dist { color: #a282ff; font-size: 0.99em;}
    .walk-time { color: #8f83e6; font-size: 0.99em;}
    .status-row { display: flex; align-items: center; gap: 14px; margin-bottom: 2px;}
    .status-dot { font-size: 1.2em;}
    .status-decreasing { color: #e40a1e; font-weight: 800;}
    .status-stable { color: #7d28ce; font-weight: 700;}
    .status-increasing { color: #119f41; font-weight: 700;}
    .price-tag { font-size: 1.2em; color: #8e14e6; font-weight: 900; margin-left: auto;}
    /* Modal */
    .modal-backdrop {
      display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(36, 17, 78, 0.18); z-index: 1000;
      align-items: center; justify-content: center;
      transition: background 0.2s;
    }
    .modal-backdrop.active { display: flex;}
    .modal-dialog {
      background: #fff; border-radius: 22px; box-shadow: 0 4px 30px #743fe430;
      padding: 30px 36px 26px 36px; min-width: 330px; max-width: 98vw; max-height: 92vh;
      color: #421d79; font-family: 'Montserrat', Arial, sans-serif; position: relative;
      animation: modalShow 0.22s cubic-bezier(.22,1,.26,1);
    }
    @keyframes modalShow {
      from { opacity: 0; transform: scale(0.92) translateY(48px);}
      to { opacity: 1; transform: scale(1) translateY(0);}
    }
    .modal-close {
      position: absolute; right: 14px; top: 15px; font-size: 1.3em; color: #9c7be1; cursor: pointer;
      border: none; background: none; font-family: inherit;
      transition: color 0.16s;
    }
    .modal-close:hover { color: #e43a6c;}
    .modal-header { font-size: 1.28em; font-weight: 900; margin-bottom: 5px;}
    .modal-content { font-size: 1.02em; margin-bottom: 7px;}
    /* Toast/alert for Filter/Sort */
    .custom-toast {
      position: fixed; left: 50%; bottom: 50px; transform: translateX(-50%);
      background: #6636d6; color: #fff; padding: 17px 42px; border-radius: 19px;
      box-shadow: 0 2px 16px #9b7fff48;
      font-size: 1.12em; font-weight: 800; z-index: 2000;
      display: none; align-items: center; gap: 10px;
      animation: toastShow 0.24s cubic-bezier(.22,1,.22,1);
    }
    .custom-toast.active { display: flex;}
    @keyframes toastShow { from { opacity: 0; transform: translate(-50%, 40px);} to { opacity: 1; transform: translate(-50%, 0);} }
    @media (max-width: 1100px) {.main-wrap { flex-direction: column; gap: 16px;}}
    @media (max-width: 700px) {.main-wrap { flex-direction: column; gap: 8px;} .side-section { width: 100%;}}

    #loadingMask {
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.22s;
    }
    #loadingMask.active {
        display: flex !important;
        opacity: 1;
        pointer-events: auto;
    }

    .golden-glow {
  color: #ffe441;
  font-weight: 900;
  text-shadow:
    /* Black thick border (outer edge) */
    -2px -2px 2px #222,
    2px -2px 2px #222,
    -2px 2px 2px #222,
    2px 2px 2px #222,
    /* Thinner black border (connecting the middle) */
    -1px 0px 1px #222,
    1px 0px 1px #222,
    0px -1px 1px #222,
    0px 1px 1px #222,
    /* Golden glow (periphery) */
    0 0 14px #ffd900cc,
    0 0 2px #ffd900cc,
    0 1px 6px #fff8,
    0 0 18px #ffe441b0;
}

/* Place it in live_parking.css or <style>. */
.refresh-highlight {
    border: 3px solid transparent;
    border-radius: 8px;
    background-image: linear-gradient(white, white), 
                      linear-gradient(90deg, gold, orange, gold);
    background-origin: border-box;
    background-clip: padding-box, border-box;
    animation: border-glow 1s linear infinite;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
}

@keyframes border-glow {
    0% {
        box-shadow: 0 0 5px gold, 0 0 10px orange;
    }
    50% {
        box-shadow: 0 0 15px orange, 0 0 30px gold;
    }
    100% {
        box-shadow: 0 0 5px gold, 0 0 10px orange;
    }
}
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <div class="navbar-content">
      <div class="logo-row">
        <img src="{% static 'TA12_logo_V2-removebg-preview.png' %}" alt="Logo"/>
        <span class="site-title">ParkSpero Melbourne</span>
      </div>
      <div class="marquee-bar">
        <span class="marquee-text">
          <img class="marquee-car-img" src="{% static 'car-icon-gif-hd-png-download.png' %}" alt="car" />
          G’day from ParkSpero Melbourne! TA12 brings you easier parking
        </span>
      </div>
      <div class="nav-links">
        <a class="nav-link" href="{% url 'home' %}"><i class="lucide lucide-home"></i>Home</a>
        <a class="nav-link {% if request.resolver_match.url_name == 'live_parking' %}active{% endif %}" href="{% url 'live_parking' %}"><i class="lucide lucide-info"></i>Live Parking</a>
        <a class="nav-link" href="{% url 'predictions' %}"><i class="lucide lucide-bar-chart-3"></i>Predictions</a>
        <a class="nav-link" href="{% url 'analytics' %}"><i class="lucide lucide-parking-circle"></i>Analytics</a>
        <!--<a class="nav-link" href="{% url 'contact' %}"><i class="lucide lucide-mail"></i>Contact</a>-->
      </div>
    </div>
  </div>

  <!-- MAIN LAYOUT -->
  <div class="main-wrap">
    <!-- Left: Real-time Parking Map -->
    <div class="card-section">
        <div class="main-card">
            <h3>Discover Real-Time Parking in Melbourne CBD</h3>
            <p>No more circling for hours—check real-time spot availability, arrive and secure your spot instantly.</p>
            <div class="spot-balls" id="spotBalls">
              <!--<div class="spot-ball">
                  <div class="spot-circle spot-green"></div>
                  <span class="spot-title">Collins St</span>
                  <span class="spot-desc green">Plenty of spaces</span>
              </div>
              <div class="spot-ball">
                  <div class="spot-circle spot-yellow"></div>
                  <span class="spot-title">Bourke St</span>
                  <span class="spot-desc yellow">Moderate</span>
              </div>
              <div class="spot-ball">
                  <div class="spot-circle spot-red"></div>
                  <span class="spot-title">Flinders St</span>
                  <span class="spot-desc red">Filling up fast</span>
              </div>-->
            </div>
            <div class="action-btns">
            <!--<button class="btn-action"><i class="lucide lucide-map-pin"></i> Find Near Me</button>
            <button class="btn-action"><i class="lucide lucide-zap"></i> Smart Suggest</button>-->
        </div>
    </div>
    <!-- Google Map block -->
    <div class="gmap-card">
        <div id="parkingMap" style="width:100%;height:340px;border-radius:22px;"></div>
    </div>
    </div>
    <!-- Right: Available Parking Spots -->
    <div class="side-section">
  <div class="side-card">
    
    <!-- Header + Toolbar -->
    <div class="side-header">
      <span class="side-title">Available Parking Spots</span>
      <div class="side-tools">
        <button class="side-btn" id="filterBtn">
          <i class="lucide lucide-filter"></i> Filter
        </button>
        <button class="btn-action"><i class="lucide lucide-refresh-cw"></i> Refresh</button>
      </div>
    </div>
    <p>Find the best parking spots near you with real-time availability and walking distance.</p>

    <!-- Parking list -->
    <div class="parking-list">
      {% for spot in parking_spots %}
      <div class="parking-spot-card" tabindex="0" data-index="{{ forloop.counter0 }}">
        <div class="card-row">
          <div>
            <div class="spot-name">{{ spot.name }}</div>
            <div class="spot-address">{{ spot.address }}</div>
          </div>
          <span class="badge-available {{ spot.badge }}">
            {{ spot.available }}/{{ spot.total }} available
          </span>
        </div>
        <div class="card-row2">
          <span class="walk-dist"><i class="lucide lucide-map-pin"></i> {{ spot.distance }}</span>
          <span class="walk-time"><i class="lucide lucide-clock"></i> {{ spot.walkTime }} walk</span>
          <!--<span class="price-tag">{{ spot.price }}</span>-->
        </div>
        <div class="status-row">
          {% if spot.prediction == 'decreasing' %}
            <span class="status-dot status-decreasing"><i class="lucide lucide-trending-down"></i> Filling up</span>
          {% elif spot.prediction == 'stable' %}
            <span class="status-dot status-stable"><i class="lucide lucide-minus"></i> Stable</span>
          {% elif spot.prediction == 'increasing' %}
            <span class="status-dot status-increasing"><i class="lucide lucide-trending-up"></i> More spots soon</span>
          {% endif %}
        </div>
        <div class="hover-tip"><i class="lucide lucide-info"></i> Click for details</div>
      </div>
      {% endfor %}
    </div>

  </div>
</div>
  </div>

  <!-- Modal (hidden by default) -->
  <div class="modal-backdrop" id="spotModal">
    <div class="modal-dialog">
      <button class="modal-close" onclick="closeModal()"><i class="lucide lucide-x"></i></button>
      <div class="modal-header" id="modalTitle"></div>
      <div class="modal-content" id="modalContent"></div>
    </div>
  </div>

  <!-- Toast -->
  <div class="custom-toast" id="toast"><i class="lucide lucide-loader-2"></i> <span id="toastMsg"></span></div>

<script>
/* =========================
   Toast (small bottom alert)
   ========================= */
function showToast(msg) {
  const toast = document.getElementById('toast');
  const msgbox = document.getElementById('toastMsg');
  msgbox.innerText = msg;
  toast.classList.add('active');
  setTimeout(() => toast.classList.remove('active'), 1600);
}

/* ==========================================
   Initial data injected from Django template
   ========================================== */
const parkingSpots = [
  {% for spot in parking_spots %}
  {
    name: "{{ spot.name|escapejs }}",
    address: "{{ spot.address|escapejs }}",
    available: {{ spot.available }},
    total: {{ spot.total }},
    distance: "{{ spot.distance|escapejs }}",
    walkTime: "{{ spot.walkTime|escapejs }}",
    price: "{{ spot.price|escapejs }}",
    prediction: "{{ spot.prediction|escapejs }}",  // decreasing | stable | increasing
    badge: "{{ spot.badge|default_if_none:''|escapejs }}", // red | yellow | green
    lat: {{ spot.lat }},
    lng: {{ spot.lng }}
  }{% if not forloop.last %},{% endif %}
  {% endfor %}
];

/* ==========================================================
   Left 3 dynamic dots (always 1 red, 1 green, 1 yellow)
   ========================================================== */
function ratio(s) { return s.total > 0 ? s.available / s.total : 0; }

function renderSpotBalls(listData) {
  const box = document.getElementById('spotBalls');
  if (!box) return;

  const list = (listData && listData.length ? listData : parkingSpots).slice();

  // Candidate pools by color/prediction
  const redPool = list
    .filter(s => (s.badge||'').includes('red') || s.prediction === 'decreasing')
    .sort((a,b) => ratio(a) - ratio(b)); // more crowded first

  const greenPool = list
    .filter(s => (s.badge||'').includes('green') || s.prediction === 'increasing')
    .sort((a,b) => ratio(b) - ratio(a)); // more empty first

  const yellowPool = list
    .filter(s => (s.badge||'').includes('yellow') || s.prediction === 'stable')
    .sort((a,b) => Math.abs(0.5 - ratio(a)) - Math.abs(0.5 - ratio(b))); // closest to middle

  // Fallbacks if any pool is empty
  const fallbackMostCrowded = list.slice().sort((a,b)=>ratio(a)-ratio(b));
  const fallbackMostEmpty   = list.slice().sort((a,b)=>ratio(b)-ratio(a));
  const fallbackMiddle      = list.slice().sort((a,b)=>Math.abs(0.5-ratio(a)) - Math.abs(0.5-ratio(b)));

  const picks = [];
  const seen  = new Set();
  function takeOne(pool) {
    for (const s of pool) {
      const key = s.name + '|' + s.address;
      if (!seen.has(key)) { seen.add(key); picks.push(s); return; }
    }
  }

  // Force pick: red -> green -> yellow
  takeOne(redPool.length ? redPool : fallbackMostCrowded);
  takeOne(greenPool.length ? greenPool : fallbackMostEmpty);
  takeOne(yellowPool.length ? yellowPool : fallbackMiddle);

  // Render 3 dots
  const items = picks.map((s, idx) => {
    const role = idx === 0 ? 'red' : idx === 1 ? 'green' : 'yellow';
    const circleClass = role === 'red' ? 'spot-red' : role === 'green' ? 'spot-green' : 'spot-yellow';
    const descText = role === 'red' ? 'Avoid now' : role === 'green' ? 'Recommended' : 'Stable / moderate';

    return `
      <div class="spot-ball" tabindex="0" title="${s.available}/${s.total} available • ${s.distance}, ${s.walkTime}">
        <div class="spot-circle ${circleClass}"></div>
        <span class="spot-title">${s.name}</span>
        <span class="spot-desc ${role}">${descText}</span>
      </div>
    `;
  });

  box.innerHTML = items.join('');
  if (window.lucide) lucide.createIcons();
}

/* ==========================================================
   Right list rendering + Modal bindings
   ========================================================== */
function rebindCardClicks(currentList) {
  const cards = document.querySelectorAll('.parking-spot-card');
  cards.forEach((card, idx) => {
    card.onclick = () => {
      const spot = currentList[idx];

      // Open modal (original behavior)
      document.getElementById('modalTitle').innerHTML =
        `<i class="lucide lucide-parking-circle"></i> ${spot.name}`;
      document.getElementById('modalContent').innerHTML = `
        <div style="font-size:1.08em; margin-bottom:8px; color:#8952e7;"><b>Address:</b> ${spot.address}</div>
        <div><b>Available:</b> ${spot.available}/${spot.total}</div>
        <div><b>Walking distance:</b> ${spot.distance}, <b>Time:</b> ${spot.walkTime}</div>
        <div><b>Status:</b> ${
          spot.prediction === 'decreasing'
            ? '<span style="color:#e40a1e;font-weight:700"><i class="lucide lucide-trending-down"></i> Filling up soon</span>'
            : spot.prediction === 'stable'
            ? '<span style="color:#7d28ce;font-weight:700"><i class="lucide lucide-minus"></i> Stable</span>'
            : '<span style="color:#119f41;font-weight:700"><i class="lucide lucide-trending-up"></i> More spots soon</span>'
        }</div>
      `;
      document.getElementById('spotModal').classList.add('active');
      setTimeout(() => { if (window.lucide) lucide.createIcons(); }, 10);

      // NEW: also focus the map & open the marker for this spot
      openSpotOnMap(spot);
    };
    card.onkeydown = (e) => { if (e.key === 'Enter') card.click(); };
  });
}

function renderParkingList(listData) {
  const list = document.querySelector('.parking-list');
  list.innerHTML = listData.map(spot => `
    <div class="parking-spot-card" tabindex="0">
      <div class="card-row">
        <div>
          <div class="spot-name">${spot.name}</div>
          <div class="spot-address">${spot.address}</div>
        </div>
        <span class="badge-available ${spot.badge}">
          ${spot.available}/${spot.total} available
        </span>
      </div>
      <div class="card-row2">
        <span class="walk-dist"><i class="lucide lucide-map-pin"></i> ${spot.distance}</span>
        <span class="walk-time"><i class="lucide lucide-clock"></i> ${spot.walkTime} walk</span>
      </div>
      <div class="status-row">
        ${
          spot.prediction === 'decreasing'
            ? '<span class="status-dot status-decreasing"><i class="lucide lucide-trending-down"></i> Filling up</span>'
            : spot.prediction === 'stable'
            ? '<span class="status-dot status-stable"><i class="lucide lucide-minus"></i> Stable</span>'
            : '<span class="status-dot status-increasing"><i class="lucide lucide-trending-up"></i> More spots soon</span>'
        }
      </div>
    </div>
  `).join('');
  if (window.lucide) lucide.createIcons();
  rebindCardClicks(listData);
}

/* =========================
   Modal close interactions
   ========================= */
function closeModal() { document.getElementById('spotModal').classList.remove('active'); }
document.getElementById('spotModal').onclick = (e) => { if (e.target === e.currentTarget) closeModal(); };
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

/* =========================
   Google Map + markers (fixed)
   ========================= */
// Globals for map/markers
let _map, _markers = [], _infoWindow;

// Index to find markers by spot (keyed by "lat,lng")
const _markerByKey = new Map();
const spotKey = s => `${s.lat},${s.lng}`;

function initParkingMap() {
  const center = { lat: -37.814, lng: 144.96332 };
  _map = new google.maps.Map(document.getElementById('parkingMap'), {
    center,
    zoom: 15,
    mapId: "DEMO_MAP_ID",
    streetViewControl: false,
    fullscreenControl: false
  });

  // Reuse a single InfoWindow instance
  _infoWindow = new google.maps.InfoWindow();

  drawMarkers(parkingSpots);
}

function drawMarkers(list) {
  if (!_map) return;

  // Clear old markers and index
  _markers.forEach(m => (m.map = null));
  _markers = [];
  _markerByKey.clear();

  list.forEach(spot => {
    // Custom marker content (image)
    const img = document.createElement('img');
    img.src = "{% static 'parking-sign-lightblue.png' %}";
    img.style.width = "32px";
    img.style.height = "32px";
    img.style.display = "block";
    img.style.cursor = "pointer";

    const marker = new google.maps.marker.AdvancedMarkerElement({
      map: _map,
      position: { lat: spot.lat, lng: spot.lng },
      title: spot.name,
      content: img
    });

    const html = `
      <div style="font-size:0.95em;min-width:150px;padding:3px 5px;line-height:1.2;">
        <b style="color:#5b2c91;">${spot.name}</b><br>
        <span style="color:#555;">${spot.address}</span><br>
        <span style="color:#059640;font-weight:600;">${spot.available}/${spot.total} available</span><br>
        <span style="color:#8e14e6;font-weight:600;">${spot.price || ''}</span>
      </div>
    `;

    // Open info when marker itself is clicked
    marker.addListener('click', () => {
      _infoWindow.setContent(html);
      _infoWindow.open({ anchor: marker, map: _map, shouldFocus: false });
    });

    // Index by key and keep references
    _markerByKey.set(spotKey(spot), { marker, html, spot });
    _markers.push(marker);
  });
}

/* Open a marker on the map for a given spot (used when list item is clicked) */
function openSpotOnMap(spot, { pan = true, zoom = 16 } = {}) {
  const entry = _markerByKey.get(spotKey(spot));
  if (!entry || !_map) return;

  if (pan) {
    _map.panTo({ lat: spot.lat, lng: spot.lng });
    if (_map.getZoom() < zoom) _map.setZoom(zoom);
  }
  _infoWindow.setContent(entry.html);
  _infoWindow.open({ anchor: entry.marker, map: _map, shouldFocus: false });
}

/* =========================
   Full-page Loading Mask
   ========================= */
function showLoadingMask() {
  const mask = document.getElementById('loadingMask');
  mask.style.display = 'flex';
  setTimeout(() => mask.classList.add('active'), 10);
}
function hideLoadingMask() {
  const mask = document.getElementById('loadingMask');
  mask.classList.remove('active');
  setTimeout(() => mask.style.display = 'none', 250);
}

/* =========================================
   Show mask when navigating via top navbar
   ========================================= */
function attachNavLoading() {
  const links = document.querySelectorAll('.navbar .nav-link');
  links.forEach(a => {
    a.addEventListener('click', (e) => {
      const href = a.getAttribute('href');
      if (!href) return;
      const url = new URL(href, window.location.origin);

      // Do not intercept: new tab, external site, or same page
      if (a.target === '_blank' || url.origin !== location.origin || url.pathname === location.pathname) {
        return;
      }

      e.preventDefault();
      showLoadingMask();
      setTimeout(() => { window.location.href = url.href; }, 1200);
    });
  });
}
// Optional: show mask on normal page unloads
window.addEventListener('beforeunload', () => { showLoadingMask(); });

/* =========================
   Refresh list (API fetch)
   ========================= */
function refreshParkingList() {
  const list = document.querySelector('.parking-list');
  list.classList.add('refresh-highlight');

  fetch("{% url 'live_parking_api' %}")
    .then(res => res.json())
    .then(data => {
      // Keep the same array reference so other parts stay in sync
      parkingSpots.length = 0;
      parkingSpots.push(...data);

      // Re-render everything that depends on the data
      renderParkingList(parkingSpots);
      renderSpotBalls(parkingSpots);
      drawMarkers(parkingSpots);

      setTimeout(() => list.classList.remove('refresh-highlight'), 2000);
    })
    .catch(err => {
      console.error("Refresh failed", err);
      list.classList.remove('refresh-highlight');
    });
}
// Bind the toolbar Refresh button (right column)
document.querySelector('.side-tools .btn-action').addEventListener('click', refreshParkingList);

/* ===================================
   Filter button (≤ 0.4km & >0 spaces)
   =================================== */
document.getElementById('filterBtn').addEventListener('click', function () {
  const filtered = parkingSpots.filter(spot => {
    const distNum = parseFloat(spot.distance);
    const inKm = spot.distance.includes("km") ? distNum : distNum / 1000;
    return spot.available > 0 && inKm <= 0.4;
  });
  renderParkingList(filtered);
  renderSpotBalls(filtered);
  drawMarkers(filtered);
  showToast('Filtered: under 400m with available spots');
});

/* =========================
   First load
   ========================= */
window.onload = function () {
  hideLoadingMask();
  if (window.lucide) lucide.createIcons();
  renderParkingList(parkingSpots);
  renderSpotBalls(parkingSpots);
  attachNavLoading(); // enable nav overlay when navigating between pages
};
</script>



    <!-- Full Page Loading Mask -->
    <div id="loadingMask"
    style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;
    background:rgba(32,18,77,0.16);backdrop-filter:blur(2.5px);
    align-items:center;justify-content:center;transition:opacity .22s;">
    <div style="background:#ffffff3c;border-radius:26px;padding:40px 60px;box-shadow:0 8px 28px #421d7999;
        display:flex;flex-direction:column;align-items:center;gap:16px;">
        <img src="{% static 'car_loading.gif' %}" alt="Loading..." style="width:450px;height:350px;display:block;">
        <span class="golden-glow" style="font-size:3em;letter-spacing:.8px;">Loading…</span>
    </div>
    </div>

  <script src="https://cdn.jsdelivr.net/npm/lucide-static@latest"></script>
  <!-- Replace with your Google Maps API KEY -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAdEHtcGUCJlLkNKVOenB9xZCQATcGaPkU&callback=initParkingMap&v=weekly&libraries=marker&language=en" async defer></script>

</body>
</html>
