{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Parking Predictions | ParkSpero Melbourne</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@latest/font/lucide.css">
  <style>
    html, body { height: 100%; }
    body {
      margin: 0; padding: 0;
      font-family: 'Montserrat', Arial, sans-serif;
      background: linear-gradient(to bottom, #6002ee 0%, #3a1397 60%, #102178 100%);
      min-height: 100vh; color: #452179;
    }
    .navbar { width: 100%; background: linear-gradient(90deg, #be7bf6 0%, #9400ff 80%); display: flex; align-items: center; justify-content: center; gap: 40px; padding: 0 32px; position: relative; min-height: 90px; box-sizing: border-box;}
    .navbar-content { width: 100%; max-width: 1500px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between;}
    .logo-row { display: flex; align-items: center; gap: 18px;}
    .logo-row img { height: 106px; width: 106px; object-fit: contain; filter: drop-shadow(0 2px 10px #1d1a2e80);}
    .site-title { font-size: 1.8rem; font-weight: 900; color: #ffe441; letter-spacing: 1.5px; text-shadow: 0 2px 8px #32246888;}
    .marquee-bar { background: linear-gradient(90deg, #be7bf6cc 0%, #ffe441ee 85%); border-radius: 16px; min-width: 320px; max-width: 320px; height: 44px; margin: 0 18px; box-shadow: 0 2px 12px #963be333, 0 1px 8px #ffe44135; display: flex; align-items: center; overflow: hidden; padding: 0 20px; position: relative;}
    .marquee-text { display: flex; align-items: center; white-space: nowrap; font-weight: 900; color: #421d79; font-size: 1.09em; animation: marquee-move 12s linear infinite; letter-spacing: 0.5px; text-shadow: 0 1px 6px #fff8, 0 1px 3px #be7bf6cc;}
    .marquee-car-img { vertical-align: middle; display: inline-block; height: 22px; margin-right: 12px; margin-bottom: 2px; filter: drop-shadow(0 2px 8px #ffe44190);}
    @keyframes marquee-move { 0% { transform: translateX(50%);} 100% { transform: translateX(-100%);} }
    .nav-links { display: flex; align-items: center; gap: 5px; font-weight: 700; font-size: 0.8rem;}
    .nav-link { color: #ffffff; text-decoration: none; display: flex; align-items: center; gap: 5px; transition: opacity 0.15s; opacity: 0.93; font-size: 1.18em; font-weight: 900; padding: 0.22em 0.86em; border-radius: 10px; position: relative; cursor: pointer;}
    .nav-link:hover, .nav-link:focus-visible { color: #ffd900 !important; text-shadow: 0 0 14px #ffd900cc, 0 0 2px #ffd900cc, 0 1px 6px #fff8; outline: none; opacity: 1; background: none; box-shadow: none;}
    .nav-link.active { color: #ffd900 !important; text-shadow: 0 0 14px #ffd900cc, 0 0 2px #ffd900cc, 0 1px 6px #fff8;}

    .container { max-width: 1300px; margin: 32px auto 48px auto; padding: 0 18px; }
    .page-header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 18px; }
    .page-title { color: #ffe441; font-size: 2rem; font-weight: 900; letter-spacing: .5px; }
    .updated-badge { background: #ffffff26; border: 1px solid #ffffff44; color: #fff; padding: 10px 14px; border-radius: 12px; font-weight: 800; font-size: .98rem; backdrop-filter: blur(2px); }
    .updated-badge.stale { background: #ffb3b326; border-color: #ffb3b380; color: #fff2f2; }

    .chips { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin-bottom: 22px; }
    .chip { background: #faf5ff; border: 1.7px solid #d1a7ff30; border-radius: 14px; padding: 14px 12px; box-shadow: 0 3px 20px #c8b4ff22; display: flex; flex-direction: column; gap: 6px; min-height: 88px; }
    .chip .label { font-size: .9rem; font-weight: 900; color: #702ccf; letter-spacing: .3px; }
    .chip .count { font-size: 1.8rem; font-weight: 900; transition: opacity .2s; }
    .chip.loading .label, .chip.loading .count { opacity: .4; }

    .chip.green .count { color: #13ad48; } .chip.orange .count { color: #ff7b00; }
    .chip.amber .count { color: #e4a300; } .chip.yellow .count { color: #d9bf00; }
    .chip.blue .count { color: #3a66c7; } .chip.purple .count { color: #7a3df0; }

    .card { position: relative; border-radius: 16px; box-shadow: 0 3px 20px #c8b4ff22; margin-bottom: 22px; padding: 1.5em 1.4em 1.2em 1.4em; background: #faf5ff; border: 1.7px solid #d1a7ff30; }
    .card-title { color: #702ccf; font-size: 1.2em; font-weight: 900; margin-bottom: 10px; }

    /* 工具列（Dropdown） */
    .table-tools { display:flex; align-items:center; gap:12px; flex-wrap:wrap; background:#fff; border:1.6px solid #eee7ff; border-radius:12px; padding:10px; margin-bottom:10px; box-shadow:0 3px 15px #1c00631a;}
    .table-tools label { font-weight:900; color:#5323a4; }
    .table-tools select { font-weight:800; padding:8px 10px; border-radius:10px; border:1.4px solid #e1d7ff; outline:none; }

    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden; border: 1.6px solid #eee7ff; box-shadow: 0 3px 15px #1c00631a;}
    thead th { text-align: left; background: #f4f0ff; color: #5323a4; padding: 12px 10px; font-weight: 900; font-size: .95rem; border-bottom: 1px solid #eae1ff; }
    tbody td { padding: 11px 10px; border-bottom: 1px solid #f1ebff; color: #35155e; font-weight: 700; font-size: .98rem; }
    tbody tr:hover { background: #faf7ff; }

    .badge { display: inline-block; padding: 6px 10px; border-radius: 999px; font-weight: 900; font-size: .84rem; border: 1.5px solid transparent; }
    .b-unocc { background: #e9fff0; color: #119f41; border-color: #98f3b8; }
    .b-15m { background:#fff1e6; color:#c55600; border-color:#ffcba3; }
    .b-30m { background:#fffbe7; color:#c98e0f; border-color:#ffec98; }
    .b-60m { background:#fffde9; color:#bb8b09; border-color:#ffe09d; }
    .b-gt60 { background:#f5faff; color:#3a66c7; border-color:#b7d5ff; }
    .b-perm { background:#f2e9ff; color:#6d2ff0; border-color:#cdb3ff; }

    /* Loading skeleton */
    .skeleton { position: relative; overflow: hidden; background: #eee9ff; }
    .skeleton::after {
      content: ""; position: absolute; inset: 0;
      transform: translateX(-100%);
      background: linear-gradient(90deg, transparent, #ffffffaa, transparent);
      animation: shimmer 1.2s infinite;
    }
    @keyframes shimmer { 100% { transform: translateX(100%);} }

    #loadingMask { opacity: 0; pointer-events: none; transition: opacity .22s; }
    #loadingMask.active { display: flex !important; opacity: 1; pointer-events: auto; }

    .golden-glow { color: #ffe441; font-weight: 900; text-shadow:-2px -2px 2px #222,2px -2px 2px #222,-2px 2px 2px #222,2px 2px 2px #222,-1px 0px 1px #222,1px 0px 1px #222,0px -1px 1px #222,0px 1px 1px #222,0 0 14px #ffd900cc,0 0 2px #ffd900cc,0 1px 6px #fff8,0 0 18px #ffe441b0; }

    /* Empty Street Red Letters & Page Layout */
    .no-street { color:#d30820; font-weight:900; }
    .pager { display:flex; align-items:center; gap:10px; margin-top:12px; }
    .pager button { background:#111; color:#fff; border:none; border-radius:10px; padding:6px 12px; font-weight:800; cursor:pointer; }
    .pager button[disabled] { opacity:.4; cursor:not-allowed; }
    .pager .info { font-weight:900; color:#5323a4; }

    /* Empty state overlay inside card */
    #empty-state {
      display:none; position:absolute; inset:0; background:rgba(250,245,255,0.92);
      backdrop-filter: blur(1px);
      border-radius: 16px;
      align-items:center; justify-content:center; text-align:center; padding:28px;
      gap:14px; flex-direction:column;
    }
    #empty-state .hint { color:#5323a4; font-weight:900; }
    #empty-state .retry {
      margin-top:8px; background:#5323a4; color:#fff; border:none; border-radius:12px;
      padding:10px 16px; font-weight:900; cursor:pointer;
      box-shadow: 0 3px 12px #1c00631a;
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <div class="navbar-content">
      <div class="logo-row">
        <img src="{% static 'TA12_logo_V2-removebg-preview.png' %}" alt="Logo"/>
        <span class="site-title">ParkSpero Melbourne</span>
      </div>
      <div class="marquee-bar">
        <span class="marquee-text">
          <img class="marquee-car-img" src="{% static 'car-icon-gif-hd-png-download.png' %}" alt="car"/>
          G’day from ParkSpero Melbourne! TA12 brings you easier parking
        </span>
      </div>
      <div class="nav-links">
        <a class="nav-link" href="{% url 'home' %}"><i class="lucide lucide-home"></i>Home</a>
        <a class="nav-link" href="{% url 'live_parking' %}"><i class="lucide lucide-info"></i>Live Parking</a>
        <a class="nav-link active" href="{% url 'predictions' %}"><i class="lucide lucide-bar-chart-3"></i>Predictions</a>
        <a class="nav-link" href="{% url 'analytics' %}"><i class="lucide lucide-parking-circle"></i>Analytics</a>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="page-header">
      <div class="page-title">Predictions</div>
      <div id="pred-updated" class="updated-badge">Updated —</div>
    </div>

    <!-- SIX CLASS CHIPS -->
    <div class="chips" id="chips">
      <div class="chip green"><div class="label">Unoccupied</div><div id="count-unoccupied" class="count">0</div></div>
      <div class="chip orange"><div class="label">Vacate ≤ 15 min</div><div id="count-vacate-15" class="count">0</div></div>
      <div class="chip amber"><div class="label">Vacate ≤ 30 min</div><div id="count-vacate-30" class="count">0</div></div>
      <div class="chip yellow"><div class="label">Vacate ≤ 60 min</div><div id="count-vacate-60" class="count">0</div></div>
      <div class="chip blue"><div class="label">Occupied &gt; 60 min</div><div id="count-gt60" class="count">0</div></div>
      <div class="chip purple"><div class="label">Permit Parking</div><div id="count-permit" class="count">0</div></div>
    </div>

    <!-- TABLE CARD -->
    <div class="card" id="table-card">
      <div class="card-title">Bay-level predictions (sorted by ETA)</div>

      <!-- Toolbar: Street + Classification drop-down menu -->
      <div class="table-tools">
        <label for="streetFilter">Street:</label>
        <select id="streetFilter">
          <option value="__ALL__">All streets</option>
          <!-- The remaining options are automatically filled in by JS based on the data. -->
        </select>

        <label for="classFilter">Class:</label>
        <select id="classFilter">
          <option value="__ALL__">All classes</option>
          <option value="UNOCCUPIED">UNOCCUPIED</option>
          <option value="VACATE_15M">VACATE_15M</option>
          <option value="VACATE_30M">VACATE_30M</option>
          <option value="VACATE_60M">VACATE_60M</option>
          <option value="OCCUPIED_GT_60M">OCCUPIED_GT_60M</option>
          <option value="PERMIT_PARKING">PERMIT_PARKING</option>
        </select>

        <span id="streetCount" style="font-weight:900;color:#702ccf;"></span>
      </div>

      <table id="pred-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Street</th>
            <th>Kerbside ID</th>
            <th>Status</th>
            <th>Classification</th>
            <th>ETA to Free</th>
            <th>Rule</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- Pagination -->
      <div id="pred-pager" class="pager">
        <button id="pg-prev">Prev</button>
        <span class="info" id="pg-info">Page 1 / 1</span>
        <button id="pg-next">Next</button>
      </div>

      <!-- Empty State Overlay -->
      <div id="empty-state">
        <img src="{% static 'car_loading.gif' %}" alt="Loading..." style="width:360px;height:280px;display:block;filter: drop-shadow(0 8px 20px #421d7999);">
        <div class="golden-glow" style="font-size:2.2em;">Fetching live predictions…</div>
        <div class="hint">This can take a moment if the data source is busy. Auto-retrying in <span id="retry-in">--</span>s.</div>
        <button class="retry" id="retry-btn">Retry now</button>
      </div>
    </div>
  </div>

  <!-- Inline JS -->
  <script>
    (function () {
      const ENDPOINT = "/api/v1/predictions/";

      const countIds = {
        UNOCCUPIED: "count-unoccupied",
        VACATE_15M: "count-vacate-15",
        VACATE_30M: "count-vacate-30",
        VACATE_60M: "count-vacate-60",
        OCCUPIED_GT_60M: "count-gt60",
        PERMIT_PARKING: "count-permit",
      };

      let refreshTimer = null;
      let retryTimer = null;
      let retryCountdownTimer = null;
      let currentTTL = 60;
      let isLoading = false;

      /* Page/Filter Status */
      const PAGE_SIZE = 20;
      let allItems = [];        // Original (sorted)
      let filteredItems = [];   // After filtering by dropdown
      let currentPage = 1;
      let currentStreet = "__ALL__";
      let currentClass = "__ALL__";

      /* DOM refs */
      const chipsEl = document.getElementById('chips');
      const tableCard = document.getElementById('table-card');
      const emptyState = document.getElementById('empty-state');
      const retryInEl = document.getElementById('retry-in');
      const retryBtn = document.getElementById('retry-btn');

      function addSkeletonRows(n = 8) {
        const tbody = document.querySelector("#pred-table tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
        for (let i = 0; i < n; i++) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="skeleton" style="height:18px;border-radius:6px;"></td>
            <td class="skeleton" style="height:18px;border-radius:6px;"></td>
            <td class="skeleton" style="height:18px;border-radius:6px;"></td>
            <td class="skeleton" style="height:18px;border-radius:6px;"></td>
            <td class="skeleton" style="height:18px;border-radius:6px;"></td>
            <td class="skeleton" style="height:18px;border-radius:6px;"></td>
            <td class="skeleton" style="height:18px;border-radius:6px;"></td>
          `;
          tbody.appendChild(tr);
        }
        document.getElementById("pg-info").textContent = "Loading…";
      }

      function chipsSetLoading(on) {
        chipsEl.querySelectorAll('.chip').forEach(ch => {
          ch.classList.toggle('loading', !!on);
        });
      }

      function showEmptyState(seconds) {
        document.getElementById('pred-table').style.opacity = 0.35;
        document.getElementById('pred-pager').style.opacity = 0.35;
        emptyState.style.display = 'flex';
        startRetryCountdown(seconds);
      }

      function hideEmptyState() {
        emptyState.style.display = 'none';
        stopRetryCountdown();
        document.getElementById('pred-table').style.opacity = 1;
        document.getElementById('pred-pager').style.opacity = 1;
      }

      function startRetryCountdown(sec) {
        stopRetryCountdown();
        let remain = Math.max(5, Math.floor(sec || 15));
        retryInEl.textContent = remain;
        retryCountdownTimer = setInterval(() => {
          remain -= 1;
          retryInEl.textContent = remain;
          if (remain <= 0) {
            clearInterval(retryCountdownTimer);
          }
        }, 1000);
      }

      function stopRetryCountdown() {
        if (retryCountdownTimer) clearInterval(retryCountdownTimer);
        retryCountdownTimer = null;
      }

      function badgeFor(classification) {
        switch (classification) {
          case "UNOCCUPIED": return '<span class="badge b-unocc">Unoccupied</span>';
          case "VACATE_15M": return '<span class="badge b-15m">Vacate ≤ 15m</span>';
          case "VACATE_30M": return '<span class="badge b-30m">Vacate ≤ 30m</span>';
          case "VACATE_60M": return '<span class="badge b-60m">Vacate ≤ 60m</span>';
          case "OCCUPIED_GT_60M": return '<span class="badge b-gt60">&gt; 60m</span>';
          case "PERMIT_PARKING": return '<span class="badge b-perm">Permit</span>';
          default: return classification || "";
        }
      }

      function humanETA(item) {
        if ((item.status || "").toLowerCase() === "unoccupied") return "—";
        if (item.allowed_minutes == null) return "> 60 min";
        const remaining = Math.max(0, Math.round(item.allowed_minutes - item.minutes_elapsed));
        return `${remaining} min`;
      }

      async function fetchPredictionsWithTimeout(ms = 15000) {
        const ctrl = new AbortController();
        const to = setTimeout(() => ctrl.abort(), ms);
        try {
          const res = await fetch(ENDPOINT, { cache: "no-store", signal: ctrl.signal });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return await res.json();
        } finally {
          clearTimeout(to);
        }
      }

      function setCounts(counts) {
        Object.entries(countIds).forEach(([key, id]) => {
          const el = document.getElementById(id);
          if (el) el.textContent = counts?.[key] ?? 0;
        });
      }

      function setUpdated(genIso, ttl) {
        const el = document.getElementById("pred-updated");
        if (!el || !genIso) return;
        const gen = new Date(genIso);
        const now = new Date();
        const theAge = Math.max(0, Math.round((now - gen) / 1000));
        el.textContent = `Updated ${theAge}s ago`;
        el.classList.toggle("stale", ttl && theAge > ttl * 3);
      }

      /* Empty Street Alert */
      function renderStreet(text) {
        const s = (text || "").trim();
        return s ? s : '<span class="no-street">No street name provided</span>';
      }

      function populateStreetOptions(items) {
        const select = document.getElementById("streetFilter");
        if (!select) return;
        const names = new Set();
        items.forEach(it => {
          const s = (it.street || "").trim();
          names.add(s || "(No street name)");
        });
        const sorted = Array.from(names).sort((a,b)=>a.localeCompare(b));
        select.querySelectorAll("option:not([value='__ALL__'])").forEach(o=>o.remove());
        sorted.forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });
      }

      function setTable(items) {
        allItems = Array.isArray(items) ? items.slice() : [];

        // sort by ETA asc, unoccupied first
        allItems.sort((a, b) => {
          const unoccA = a.classification === "UNOCCUPIED" ? 0 : 1;
          const unoccB = b.classification === "UNOCCUPIED" ? 0 : 1;
          if (unoccA !== unoccB) return unoccA - unoccB;
          const aEta = a.allowed_minutes == null ? 9999 : Math.max(0, a.allowed_minutes - a.minutes_elapsed);
          const bEta = b.allowed_minutes == null ? 9999 : Math.max(0, b.allowed_minutes - b.minutes_elapsed);
          return aEta - bEta;
        });

        populateStreetOptions(allItems);
        applyFilterAndRender();
      }

      function applyFilterAndRender() {
        // Street filter
        let tmp = [];
        if (currentStreet === "__ALL__") {
          tmp = allItems.slice();
        } else if (currentStreet === "(No street name)") {
          tmp = allItems.filter(it => !(it.street || "").trim());
        } else {
          tmp = allItems.filter(it => (it.street || "").trim() === currentStreet);
        }

        // Classification filter
        if (currentClass !== "__ALL__") {
          tmp = tmp.filter(it => (it.classification || "") === currentClass);
        }

        filteredItems = tmp;
        currentPage = 1;
        renderPage(currentPage);
        updateStreetCount();
      }

      function updateStreetCount() {
        const el = document.getElementById("streetCount");
        if (!el) return;
        el.textContent = `(${filteredItems.length} results)`;
      }

      function renderPage(page) {
        const tbody = document.querySelector("#pred-table tbody");
        const total = filteredItems.length;
        const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));

        currentPage = Math.min(Math.max(1, page), totalPages);
        const start = (currentPage - 1) * PAGE_SIZE;
        const end = Math.min(start + PAGE_SIZE, total);
        tbody.innerHTML = "";

        filteredItems.slice(start, end).forEach((it, idx) => {
          const tr = document.createElement("tr");
          const rowNo = start + idx + 1;
          tr.innerHTML = `
            <td>${rowNo}</td>
            <td>${renderStreet(it.street)}</td>
            <td>${it.kerbsideid ?? ""}</td>
            <td>${it.status ?? ""}</td>
            <td>${badgeFor(it.classification)}</td>
            <td>${humanETA(it)}</td>
            <td>${it.restriction_code ?? ""}</td>
          `;
          tbody.appendChild(tr);
        });

        renderPager(totalPages);
      }

      function renderPager(totalPages) {
        const info = document.getElementById("pg-info");
        const prev = document.getElementById("pg-prev");
        const next = document.getElementById("pg-next");
        if (info) info.textContent = `Page ${currentPage} / ${totalPages}`;
        if (prev) prev.disabled = currentPage <= 1;
        if (next) next.disabled = currentPage >= totalPages;
      }

      document.addEventListener("click", (e) => {
        if (e.target && e.target.id === "pg-prev") renderPage(currentPage - 1);
        if (e.target && e.target.id === "pg-next") renderPage(currentPage + 1);
        if (e.target && e.target.id === "retry-btn") {
          stopRetryCountdown();
          if (retryTimer) clearTimeout(retryTimer);
          refreshOnce(true);
        }
      });

      document.addEventListener("change", (e) => {
        if (e.target && e.target.id === "streetFilter") {
          currentStreet = e.target.value;
          applyFilterAndRender();
        }
        if (e.target && e.target.id === "classFilter") {
          currentClass = e.target.value;
          applyFilterAndRender();
        }
      });

      function scheduleNext(ttl) {
        if (refreshTimer) clearTimeout(refreshTimer);
        const wait = Math.max(10, (ttl || 60)) * 1000; // minimum 10s
        refreshTimer = setTimeout(refreshOnce, wait);
      }

      function scheduleRetryIn(seconds) {
        if (retryTimer) clearTimeout(retryTimer);
        const wait = Math.max(5, seconds || 15) * 1000;
        startRetryCountdown(wait / 1000);
        retryTimer = setTimeout(() => refreshOnce(true), wait);
      }

      function startLoadingUI() {
        isLoading = true;
        chipsSetLoading(true);
        addSkeletonRows(8);
      }

      function stopLoadingUI() {
        isLoading = false;
        chipsSetLoading(false);
      }

      async function refreshOnce(isRetry = false) {
        try {
          startLoadingUI();
          hideEmptyState();
          const data = await fetchPredictionsWithTimeout(15000);
          currentTTL = data.ttl || 60;

          setCounts(data.counts || {});
          setTable(data.items || []);
          setUpdated(data.generated_at, currentTTL);

          // If the API returns an empty array, display 
          // a waiting overlay and automatically retry.
          if (!data.items || data.items.length === 0) {
            showEmptyState(Math.min(20, Math.max(10, currentTTL)));
            scheduleRetryIn(Math.min(20, Math.max(10, currentTTL)));
          } else {
            hideEmptyState();
            scheduleNext(currentTTL);
          }
        } catch (err) {
          console.error("Predictions fetch failed:", err);
          // The error also shows waiting for overlay + automatic retry (backoff).
          showEmptyState(isRetry ? 20 : 12);
          scheduleRetryIn(isRetry ? 20 : 12);
        } finally {
          stopLoadingUI();
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        // When loading for the first time, display 
        // the skeleton and empty state (to avoid a blank screen).
        startLoadingUI();
        addSkeletonRows(8);
        showEmptyState(12);
        refreshOnce();
      });
    })();
  </script>

  <!-- Full Page Loading Mask -->
  <div id="loadingMask"
       style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;
              background:rgba(32,18,77,0.16);backdrop-filter:blur(2.5px);
              align-items:center;justify-content:center;transition:opacity .22s;">
    <div style="background:#ffffff3c;border-radius:26px;padding:40px 60px;box-shadow:0 8px 28px #421d7999;
                display:flex;flex-direction:column;align-items:center;gap:16px;">
      <img src="{% static 'car_loading.gif' %}" alt="Loading..." style="width:450px;height:350px;display:block;">
      <span class="golden-glow" style="font-size:3em;letter-spacing:.8px;">Loading…</span>
    </div>
  </div>

  <script>
    function showLoadingMask() {
      const mask = document.getElementById('loadingMask');
      mask.style.display = 'flex';
      setTimeout(() => mask.classList.add('active'), 10);
    }
    function hideLoadingMask() {
      const mask = document.getElementById('loadingMask');
      mask.classList.remove('active');
      setTimeout(() => mask.style.display = 'none', 250);
    }
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', function(e) {
        if (link.target === "_blank" || (link.href && !link.href.startsWith(window.location.origin))) return;
        e.preventDefault();
        showLoadingMask();
        setTimeout(() => { window.location.href = link.href; }, 600);
      });
    });
    window.onload = hideLoadingMask;
  </script>
</body>
</html>
